# 외부 접속 실전 예제

## 시나리오별 설정 예제

### 시나리오 1: 가정/사무실 네트워크에서 외부 접속

#### 환경
- Windows 서버
- 가정용 라우터
- 공인 IP 있음

#### 설정 단계

1. **서버 IP 확인**
   ```powershell
   ipconfig
   # 예: 192.168.1.100
   ```

2. **방화벽 규칙 추가**
   ```powershell
   # 관리자 권한으로 실행
   New-NetFirewallRule -DisplayName "Open WebUI" -Direction Inbound -LocalPort 8080 -Protocol TCP -Action Allow
   ```

3. **라우터 포트 포워딩**
   - 라우터 관리 페이지 접속 (보통 `192.168.1.1`)
   - 포트 포워딩 메뉴
   - 설정:
     - 외부 포트: 8080
     - 내부 IP: 192.168.1.100
     - 내부 포트: 8080
     - 프로토콜: TCP

4. **공인 IP 확인**
   ```powershell
   Invoke-RestMethod -Uri "https://api.ipify.org?format=json"
   # 예: {"ip":"123.45.67.89"}
   ```

5. **접속**
   - 외부: `http://123.45.67.89:8080`
   - 내부: `http://192.168.1.100:8080`

### 시나리오 2: Linux 서버 + Nginx + HTTPS

#### 환경
- Ubuntu Server
- 도메인 있음 (예: `webui.example.com`)
- Let's Encrypt 사용

#### 설정 단계

1. **서버 준비**
   ```bash
   sudo apt update
   sudo apt install nginx certbot python3-certbot-nginx
   ```

2. **Open WebUI 실행**
   ```bash
   cd /path/to/webui/open-webui/backend
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   
   # 백그라운드 실행
   nohup python -m uvicorn open_webui.main:app --host 127.0.0.1 --port 8080 > webui.log 2>&1 &
   ```

3. **Nginx 설정**
   ```bash
   sudo nano /etc/nginx/sites-available/webui
   ```

   내용:
   ```nginx
   server {
       listen 80;
       server_name webui.example.com;
       
       location / {
           proxy_pass http://127.0.0.1:8080;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

4. **활성화 및 테스트**
   ```bash
   sudo ln -s /etc/nginx/sites-available/webui /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl restart nginx
   ```

5. **HTTPS 인증서 발급**
   ```bash
   sudo certbot --nginx -d webui.example.com
   ```

6. **방화벽 설정**
   ```bash
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw reload
   ```

7. **접속**
   - `https://webui.example.com`

### 시나리오 3: AWS EC2 배포

#### 환경
- AWS EC2 Ubuntu 인스턴스
- Elastic IP 할당

#### 설정 단계

1. **EC2 인스턴스 생성**
   - Ubuntu 22.04 LTS 선택
   - 보안 그룹:
     - SSH (22): 내 IP
     - HTTP (80): 0.0.0.0/0
     - HTTPS (443): 0.0.0.0/0

2. **SSH 접속**
   ```bash
   ssh -i your-key.pem ubuntu@your-ec2-ip
   ```

3. **서버 설정**
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install python3 python3-pip python3-venv nginx certbot python3-certbot-nginx
   
   # Open WebUI 설치
   git clone https://github.com/JamesDylanMa/webui.git
   cd webui/open-webui/backend
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

4. **서비스 파일 생성** (자동 시작)
   ```bash
   sudo nano /etc/systemd/system/open-webui.service
   ```

   내용:
   ```ini
   [Unit]
   Description=Open WebUI
   After=network.target

   [Service]
   Type=simple
   User=ubuntu
   WorkingDirectory=/home/ubuntu/webui/open-webui/backend
   Environment="PATH=/home/ubuntu/webui/open-webui/backend/venv/bin"
   ExecStart=/home/ubuntu/webui/open-webui/backend/venv/bin/python -m uvicorn open_webui.main:app --host 127.0.0.1 --port 8080
   Restart=always

   [Install]
   WantedBy=multi-user.target
   ```

5. **서비스 시작**
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable open-webui
   sudo systemctl start open-webui
   sudo systemctl status open-webui
   ```

6. **Nginx 설정** (위 시나리오 2 참고)

7. **Elastic IP 할당** (선택사항)
   - EC2 콘솔 → Elastic IPs
   - "Allocate Elastic IP address"
   - 인스턴스에 연결

### 시나리오 4: Docker로 배포

#### Docker Compose 설정

`docker-compose.yml`:
```yaml
version: '3.8'

services:
  webui:
    build:
      context: ./open-webui/backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
    environment:
      - WEBUI_AUTH=true
      - ENABLE_SIGNUP=false
      - DATA_DIR=/app/data
    restart: unless-stopped
    networks:
      - webui-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - webui
    restart: unless-stopped
    networks:
      - webui-network

networks:
  webui-network:
    driver: bridge
```

#### 실행

```bash
docker-compose up -d
```

### 시나리오 5: Windows 서버 + IIS

#### IIS를 역방향 프록시로 사용

1. **IIS 설치**
   - Windows 기능 → IIS 활성화
   - URL Rewrite 모듈 설치
   - Application Request Routing 설치

2. **웹 사이트 생성**
   - IIS 관리자 → 사이트 추가
   - 포트: 80

3. **web.config 설정**
   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <configuration>
       <system.webServer>
           <rewrite>
               <rules>
                   <rule name="ReverseProxyInboundRule1" stopProcessing="true">
                       <match url="(.*)" />
                       <action type="Rewrite" url="http://127.0.0.1:8080/{R:1}" />
                   </rule>
               </rules>
           </rewrite>
       </system.webServer>
   </configuration>
   ```

## 보안 강화 예제

### 1. IP 화이트리스트 (Nginx)

```nginx
server {
    listen 80;
    server_name webui.example.com;

    # 특정 IP만 허용
    allow 192.168.1.0/24;  # 내부 네트워크
    allow 123.45.67.89;    # 특정 IP
    deny all;

    location / {
        proxy_pass http://127.0.0.1:8080;
        # ... 기타 설정
    }
}
```

### 2. 기본 인증 추가 (Nginx)

```nginx
server {
    # ...
    
    location / {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        proxy_pass http://127.0.0.1:8080;
        # ... 기타 설정
    }
}
```

비밀번호 파일 생성:
```bash
sudo htpasswd -c /etc/nginx/.htpasswd username
```

### 3. Rate Limiting

```nginx
http {
    limit_req_zone $binary_remote_addr zone=webui_limit:10m rate=10r/s;
    
    server {
        # ...
        
        location / {
            limit_req zone=webui_limit burst=20 nodelay;
            proxy_pass http://127.0.0.1:8080;
        }
    }
}
```

## 모니터링 설정

### 1. 로그 모니터링

```bash
# 실시간 로그 확인
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# Open WebUI 로그
tail -f /path/to/webui.log
```

### 2. 헬스 체크 스크립트

`check_webui.sh`:
```bash
#!/bin/bash
if ! curl -f http://localhost:8080/health > /dev/null 2>&1; then
    echo "WebUI is down! Restarting..."
    systemctl restart open-webui
    # 알림 전송 (이메일, 슬랙 등)
fi
```

Cron에 추가:
```bash
chmod +x check_webui.sh
crontab -e
# 매 5분마다 체크
*/5 * * * * /path/to/check_webui.sh
```

## 성능 최적화

### 1. Nginx 캐싱

```nginx
location /static/ {
    alias /path/to/static/;
    expires 30d;
    add_header Cache-Control "public, immutable";
}

location /api/ {
    proxy_cache webui_cache;
    proxy_cache_valid 200 5m;
    proxy_pass http://127.0.0.1:8080;
}
```

### 2. Gzip 압축

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
```

### 3. 워커 프로세스 증가

```bash
# Open WebUI 시작 시
uvicorn open_webui.main:app --host 127.0.0.1 --port 8080 --workers 4
```

## 문제 해결 체크리스트

- [ ] 서버가 실행 중인가?
- [ ] 포트가 열려있는가?
- [ ] 방화벽 규칙이 올바른가?
- [ ] 라우터 포트 포워딩이 설정되었는가?
- [ ] DNS가 올바르게 설정되었는가? (도메인 사용 시)
- [ ] SSL 인증서가 유효한가? (HTTPS 사용 시)
- [ ] 프록시 설정이 올바른가?
- [ ] 로그에 에러가 있는가?

## 추가 리소스

- 상세 가이드: `외부_접속_설정_가이드.md`
- 빠른 시작: `외부_접속_빠른_시작.md`
- Open WebUI 문서: https://docs.openwebui.com/

